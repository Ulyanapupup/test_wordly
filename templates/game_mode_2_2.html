<!-- templates/game_mode_2_2.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Wordly Game - Room {{ room }}</title>
  <style>
    /* Стили из вашего оригинального index.html для Wordly */
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #lobby, #game {
      text-align: center;
    }
    button, input {
      padding: 8px 15px;
      margin: 5px;
      font-size: 16px;
    }
    .game-container {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .game-section {
      width: 48%;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 5px;
    }
    .letter {
      display: inline-block;
      width: 30px;
      height: 30px;
      margin: 3px;
      text-align: center;
      line-height: 30px;
      border: 1px solid #ccc;
      cursor: pointer;
      user-select: none;
    }
    .green {
      background-color: #6aaa64;
      color: white;
    }
    .yellow {
      background-color: #c9b458;
      color: white;
    }
    .gray {
      background-color: #787c7e;
      color: white;
    }
    #guessHistory {
      margin-top: 20px;
    }
    #opponentGuess {
      margin-top: 10px;
    }
    #submitEvaluation {
      margin-top: 10px;
    }
    .hidden {
      display: none;
    }
    #gameInfo {
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 5px;
    }
    #guessResults {
      margin-top: 20px;
    }
    .guess-row {
      display: flex;
      margin-bottom: 10px;
      gap: 5px;
    }
    .guess-row .letter {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="game">
    <h1>Wordly Game - Room {{ room }}</h1>
    <div id="gameStatus">Connecting...</div>
    
    <div class="game-container">
      <div class="game-section">
        <h2>Your Guessing Area</h2>
        <div id="guessSection" class="hidden">
          <input type="text" id="guessInput" maxlength="5" placeholder="Enter your guess" />
          <button id="submitGuess">Submit Guess</button>
          <div id="guessHistory"></div>
        </div>
        
        <div id="gameInfo" class="hidden">
          <h3>Game Information</h3>
          <p>Your word: <span id="myWord"></span></p>
          <p>Opponent's word: <span id="opponentWord"></span></p>
        </div>
      </div>
      
      <div class="game-section">
        <h2>Word Submission</h2>
        <div id="wordSubmission">
          <input type="text" id="secretWord" maxlength="5" placeholder="Enter your word" />
          <button id="submitWord">Submit Word</button>
        </div>
        <div id="evaluationSection" class="hidden">
          <p>Opponent's guess:</p>
          <div id="opponentGuess"></div>
          <button id="submitEvaluation">Submit Evaluation</button>
        </div>
      </div>
    </div>
  </div>

  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io();
    const room = "{{ room }}";
    const sessionId = "{{ session.session_id }}";
    
    // UI Elements
    const gameStatus = document.getElementById('gameStatus');
    const wordSubmission = document.getElementById('wordSubmission');
    const secretWordInput = document.getElementById('secretWord');
    const submitWordBtn = document.getElementById('submitWord');
    const guessSection = document.getElementById('guessSection');
    const guessInput = document.getElementById('guessInput');
    const submitGuessBtn = document.getElementById('submitGuess');
    const evaluationSection = document.getElementById('evaluationSection');
    const opponentGuess = document.getElementById('opponentGuess');
    const submitEvaluationBtn = document.getElementById('submitEvaluation');
    const guessHistory = document.getElementById('guessHistory');
    const myWordDisplay = document.getElementById('myWord');
    const opponentWordDisplay = document.getElementById('opponentWord');
    const gameInfo = document.getElementById('gameInfo');
    
    let currentEvaluation = [];
    let opponentLetters = [];
    
    // Connect to game
    socket.emit('wordly_join', { room, session_id: sessionId });
    
    // Event handlers
    submitWordBtn.addEventListener('click', () => {
      const word = secretWordInput.value.trim();
      if (word.length === 5) {
        socket.emit('wordly_submit_word', { room, session_id: sessionId, word });
        wordSubmission.style.display = 'none';
        myWordDisplay.textContent = word;
        gameInfo.classList.remove('hidden');
        gameStatus.textContent = 'Waiting for opponent...';
      }
    });
    
    submitGuessBtn.addEventListener('click', () => {
      const guess = guessInput.value.trim();
      if (guess.length === 5) {
        socket.emit('wordly_make_guess', { room, session_id: sessionId, guess });
        addGuessToHistory(guess, 'pending');
        guessInput.value = '';
      }
    });
    
    submitEvaluationBtn.addEventListener('click', () => {
      socket.emit('wordly_submit_evaluation', { 
        room, 
        session_id: sessionId,
        evaluation: currentEvaluation 
      });
      evaluationSection.classList.add('hidden');
      guessSection.classList.remove('hidden');
    });
    
    // Socket events
    socket.on('wordly_update', (data) => {
      gameStatus.textContent = `Players in room: ${data.players}/2`;
    });
    
    socket.on('wordly_word_submitted', (data) => {
      if (data.player !== sessionId) {
        gameStatus.textContent = 'Opponent submitted word. Waiting for game to start...';
      }
    });
    
    socket.on('wordly_game_started', (data) => {
	  const isMyTurn = data.current_turn === sessionId;
	  gameStatus.textContent = isMyTurn ? 'Your turn to guess!' : 'Opponent\'s turn...';
	  if (isMyTurn) {
		guessSection.classList.remove('hidden');
	  }
	});
    
    socket.on('wordly_guess_made', (data) => {
      if (data.player !== sessionId) {
        gameStatus.textContent = 'Evaluate opponent\'s guess.';
        guessSection.classList.add('hidden');
        evaluationSection.classList.remove('hidden');
        setupEvaluation(data.guess);
      }
    });
    
    socket.on('wordly_turn_changed', (data) => {
      const isMyTurn = data.next_turn === sessionId;
      gameStatus.textContent = isMyTurn ? 'Your turn to guess!' : 'Opponent\'s turn...';
      if (isMyTurn) {
        guessSection.classList.remove('hidden');
      }
    });
    
    socket.on('wordly_game_over', (data) => {
      const winnerText = data.winner === sessionId ? 'You won!' : 'You lost.';
      gameStatus.textContent = winnerText;
      guessSection.classList.add('hidden');
      evaluationSection.classList.add('hidden');
      
      // Show words
      myWordDisplay.textContent = data.words[sessionId];
      const opponentId = Object.keys(data.words).find(id => id !== sessionId);
      opponentWordDisplay.textContent = data.words[opponentId];
    });
    
    socket.on('wordly_player_left', () => {
      gameStatus.textContent = 'Opponent disconnected. Game over.';
      guessSection.classList.add('hidden');
      evaluationSection.classList.add('hidden');
    });
    
    // Helper functions (same as in your original client.js)
    function setupEvaluation(guess) {
      opponentGuess.innerHTML = '';
      currentEvaluation = new Array(5).fill(null);
      opponentLetters = guess.split('');
      
      opponentLetters.forEach((letter, index) => {
        opponentGuess.appendChild(createLetterElement(letter, index));
      });
    }
    
    function createLetterElement(letter, index) {
      const letterElement = document.createElement('div');
      letterElement.className = 'letter';
      letterElement.textContent = letter;
      letterElement.dataset.index = index;
      letterElement.dataset.state = 'none';
      
      letterElement.addEventListener('click', () => {
        const states = ['none', 'green', 'yellow', 'gray'];
        const currentState = letterElement.dataset.state;
        const currentIndex = states.indexOf(currentState);
        const nextState = states[(currentIndex + 1) % states.length];
        
        letterElement.dataset.state = nextState;
        letterElement.className = 'letter ' + nextState;
        
        currentEvaluation[index] = nextState === 'none' ? null : nextState;
      });
      
      return letterElement;
    }
    
    function addGuessToHistory(guess, result) {
      const guessElement = document.createElement('div');
      guessElement.className = 'guess';
      
      if (result === 'pending') {
        guessElement.textContent = `Your guess: ${guess} (waiting for evaluation)`;
        guessElement.style.color = '#999';
      } else {
        const resultStr = result.map((color, index) => 
          `${guess[index]}: ${color || 'none'}`).join(', ');
        guessElement.textContent = `Your guess: ${guess} - ${resultStr}`;
      }
      
      guessHistory.appendChild(guessElement);
    }
  </script>
</body>
</html>